---
layout: course
quiz-number: 7.5
quiz-title: Revis√£o 2.1
date: 2017-10-25 00:00
---

<h1>{{ page.quiz-title }}</h1>

<p>Esta √© uma revis√£o para a segunda prova.</p>

<ol>
  <li class="pergunta" value="1">
    <p>
      Na aplica√ß√£o de <u>MiniBlog</u>, o que voc√™ faria para que a lista de posts fosse exibido na ordem, sendo que os
      mais recentes apare√ßam primeiro e os mais antigos no final?
    </p>
    <p>
      Desenvolva a solu√ß√£o que voc√™ optou.
    </p>
  </li>

  <li class="resposta">
    Essa √© uma quest√£o para discuss√£o em sala.
  </li>

  <li class="pergunta" value="2">
    <p>Desenvolva a funcionalidade de modificar os <em>posts</em> do <u>MiniBlog</u>, que atenda aos seguintes requisitos:</p>

    <ol type="a">
      <li>O hor√°rio de publica√ß√£o n√£o poder√° ser alterado.</li>
      <li>
        Na visualiza√ß√£o do texto do <em>post</em>, se ele foi modificado, dever√° ser exibida a informa√ß√£o de que o
        <em>post</em> foi modificado em tal data/hora.
      </li>
      <li>
        A modifica√ß√£o do <em>post</em> deve ocorrer de forma autom√°tica, quando o usu√°rio solicitar a modifica√ß√£o, ent√£o
        essa ser√° a hora em que o <em>post</em> foi modificado.
      </li>
    </ol>

    <hr>

    <p>
      Nessa quest√£o, voc√™ dever√° alterar o esquema da tabela <kbd>Posts</kbd>, adicionando uma segunda coluna
      <code>DATETIME</code> para saber o momento da modifica√ß√£o. Use a instru√ß√£o abaixo na tabela j√° criada:
    </p>

    {% highlight sql %}ALTER TABLE Posts ADD modificado DATETIME NULL{% endhighlight %}

    <p>Assim, em resumo, para atingir os objetivos da quest√£o, voc√™ precisar√°:</p>
    <ol type="I">
      <li>Adicionar a nova coluna ao banco de dados.</li>
      <li>Adicionar o novo campo √† classe de dados <code>Post</code>.</li>
      <li>Modificar o <code>PostDao</code> para utilizar o novo campo.</li>
      <li>Adicionar um novo subcomando para exibir o formul√°rio de modifica√ß√£o e executar a a√ß√£o de modificar o
        <em>post</em> no banco de dados.</li>
    </ol>

    <p>
      OBS:
      <span style="font-weight: normal;">
        lembre-se que a coluna <u>modificado</u> √© <code>NULL</code>, portanto, para saber se o <em>post</em>
        foi modificado no Java, basta fazer a compara√ß√£o <code>modificado != null</code>.
      </span>
    </p>
  </li>

  <li class="resposta">
    <p>Esse √© um tipo de problema que √© melhor se resolvido em partes. Como a aplica√ß√£o j√° est√° estruturada em MVC, vou
      descrever a solu√ß√£o usando cada uma das camadas.</p>

    {%- assign gistAnswer2="wagnerluis1982/ca9a091cae108ba41162ee38fc357282" %}

    <hr>

    <p><b><u>Model</u></b></p>

    <p>As mudan√ßas necess√°rias na camada model s√£o bem simples, basta considerar o campo <code>modificado</code> nas
      classes modelo e de acesso a dados.</p>

    {% include gist.html id=gistAnswer2 lines="10"
            filename="Post.java"
            title="<kbd><b>Post.java</b></kbd> (classe modelo)" %}

    {% include gist.html id=gistAnswer2 lines="3,17,26"
            filename="PostDao-modificado.java"
            title="<kbd><b>PostDao.java</b></kbd> (apenas os m√©todos alterados)" %}

    <hr>

    <p><b><u>View</u></b></p>

    <p>Nas interfaces de usu√°rio, precisamos criar um formul√°rio para modificar um post e adicionar √† tela de
      visualiza√ß√£o a informa√ß√£o do campo modificado se necess√°rio.</p>

    {% include gist.html id=gistAnswer2 lines="3,8,9,10"
            filename="visualizar.jsp"
            title="<kbd><b>/posts/visualizar.jsp</b></kbd> (visualiza√ß√£o de post com aviso de modificado)" %}

    {% include gist.html id=gistAnswer2
            filename="modificar.jsp"
            title="<kbd><b>/posts/modificar.jsp</b></kbd> (nova tela com formul√°rio de modifica√ß√£o)" %}

    <p>
      O mais importante s√£o essas duas telas acima, mas tamb√©m √© necess√°rio links para o usu√°rio acessar o formul√°rio de
      de modifica√ß√£o do post, eu fiz isso na lista de posts.
    </p>

    <p>
      Mas note que h√° uma vari√°vel booleana <code>isAdmin</code> para exibir o link, como simula√ß√£o de acesso como
      administrador. Essa vari√°vel √© definida no comando <code>Posts:index</code> que usa essa tela.
    </p>

    {% include gist.html id=gistAnswer2 lines="10,11,12"
            filename="lista.jsp"
            title="<kbd><b>/posts/lista.jsp</b></kbd> (lista de posts com link para edi√ß√£o)" %}

    <hr>

    <p><b><u>Controller</u></b></p>

    <p>Eu adicionei o comando <code>Posts:atualizar</code> que √© bem parecido com o de adicionar posts, mas utiliza o
      campo <u>modificado</u>.</p>

    <p>Note que eu n√£o precisei mexer no comando <code>Posts:visualizar</code>, pense no porque ü§î</p>

    {% include gist.html id=gistAnswer2
            filename="Posts:atualizar.java"
            title="<kbd><b>Posts:atualizar</b></kbd> (novo comando)" %}

    <p>A simula√ß√£o de acesso como administrador √© feito no comando <code>Posts:index</code>.</p>

    {% include gist.html id=gistAnswer2 lines="8,9,10"
            filename="Posts:index.java"
            title="<kbd><b>Posts:index</b></kbd> (comando com altera√ß√£o)" %}

  </li>

  <li class="pergunta" value="3">
    <p>Adicione √† aplica√ß√£o <u>MiniBlog</u> o recurso de marcar um <em>post</em> com uma <em>tag</em>.</p>

    <p>A funcionalidade de <em>tags</em> dever√° funcionar da seguinte forma:</p>
    <ol type="a">
      <li>Cada <em>post</em> poder√° ser marcado com apenas uma <em>tag</em>.</li>
      <li>Poder√° haver <em>posts</em> sem marca√ß√£o.</li>
      <li>
        A cria√ß√£o de <em>tags</em> dever√° ser autom√°tica, se ao criar ou modificar um <em>post</em>, for escrito o nome
        de uma <em>tag</em> inexistente, ent√£o esta dever√° ser criada.
      </li>
      <li>
        Na visualiza√ß√£o do texto do <em>post</em>, dever√° aparecer a <em>tag</em> marcada. Se o <em>post</em> n√£o tiver
        marca√ß√£o, ent√£o dever√° ser exibido essa informa√ß√£o.
      </li>
      <li>
        N√£o ser√° necess√°rio criar telas de CRUD para as <em>tags</em>.
      </li>
    </ol>

    <hr>

    <p>As <em>tags</em> ser√£o mantidas na tabela <kbd>Tags</kbd>:</p>

    <table class="opcoes">
      <tr>
        <td><img src="un2/tags.svg"></td>
        <td>{% highlight sql %}{% include_relative un2/create-tags.sql %}{% endhighlight %}</td>
      </tr>
    </table>

    <p>E √© preciso criar a chave estrangeira na tabela <kbd>Posts</kbd>:</p>

    {% highlight sql %}ALTER TABLE Posts ADD tag_id INT NULL REFERENCES Tags (id){% endhighlight %}

    <p>Estou fornecendo tamb√©m as classes de acesso a dados <code>Tag</code> e <code>TagDao</code>, com os m√©todos
      necess√°rios para a quest√£o.</p>

    <details>
      <summary><kbd>Tag.java</kbd></summary>
      {% highlight java %}{% include_relative un2/Tag.java %}{% endhighlight %}
    </details>

    <details>
      <summary><kbd>TagDao.java</kbd></summary>
      {% highlight java %}{% include_relative un2/TagDao.java %}{% endhighlight %}
    </details>
  </li>

  <li class="resposta">
    <p>Esse <ins>tamb√©m</ins> √© um tipo de problema melhor resolvido em partes. Mas dessa vez vou apresentar as camadas
      em ordem contr√°ria.</p>

    {%- assign gistAnswer3="wagnerluis1982/f083e86fa8867264bc75a445c1d297f4" %}

    <hr>

    <p><b><u>View</u></b></p>

    <p>Primeiramente, na cria√ß√£o/modifica√ß√£o de um post, √© preciso que o usu√°rio possa indicar a tag usada. Para isso,
      devemos modificar as telas de formul√°rio para ter esse novo campo.</p>

    {% include gist.html id=gistAnswer3 lines="11-13"
            filename="adicionar-r213.jsp"
            title="<kbd><b>/posts/adicionar.jsp</b></kbd> (formul√°rio com novo campo tag)" %}

    {% include gist.html id=gistAnswer3 lines="13-15"
            filename="modificar-r213.jsp"
            title="<kbd><b>/posts/modificar.jsp</b></kbd> (formul√°rio com novo campo tag)" %}

    <p>E, para completar, ao visualizar um post, o usu√°rio quer saber qual a tag marcada. Nesse caso, modificamos a tela
      de visualiza√ß√£o de post.</p>

    {% include gist.html id=gistAnswer3 lines="12-21"
            filename="visualizar-r213.jsp"
            title="<kbd><b>/posts/visualizar.jsp</b></kbd> (visualiza√ß√£o de post com a tag)" %}

    <hr>

    <p><b><u>Controller</u></b></p>

    <p>Basicamente, precisamos alterar o c√≥digo dos comandos para a nova situa√ß√£o.</p>

    {% include gist.html id=gistAnswer3 lines="18-25"
            filename="Posts:visualizar-r213.java"
            title="<kbd><b>Posts:visualizar</b></kbd> (alterado para obter tag)" %}

    {% include gist.html id=gistAnswer3 lines="17-21,28"
            filename="Posts:publicar-r213.java"
            title="<kbd><b>Posts:publicar</b></kbd> (alterado para publicar post com uma tag)" %}

    {% include gist.html id=gistAnswer3 lines="12-16,23"
            filename="Posts:atualizar-r213.java"
            title="<kbd><b>Posts:atualizar</b></kbd> (alterado para atualizar post com uma tag)" %}

    {% include gist.html id=gistAnswer3
            filename="Posts:obterOuCriarTag.java"
            title="<kbd><b>obterOuCriarTag()</b></kbd> (m√©todo interno da classe do comando)" %}

    <hr>

    <p><b><u>Model</u></b></p>

    <p>Primeiramente, eu atualizei o DAO de <em>tags</em> para ter um m√©todo de obter uma tag pelo nome.</p>

    {% include gist.html id=gistAnswer3
            filename="TagDao:obterPorNome.java"
            title="<kbd><b>obterPorNome()</b></kbd> (novo m√©todo de <code>TagDao</code>)" %}

    <p>Depois, eu atualizei a classe <code>Post</code> para adicionar o novo campo.</p>

    {% include gist.html id=gistAnswer3
            filename="Post-r213.java" lines="11"
            title="<kbd><b>Post.java</b></kbd> (classe modelo com novo campo)" %}

    <p>E, por √∫ltimo, atualizei o DAO de <em>posts</em> para utilizar o novo campo.</p>
    <p>Note nas linhas 9, 22 e 45 a chamada <code>addColumnMapping("tag_id", "tagId")</code>. Isso √© um
      mapeamento da coluna <code>tag_id</code> da tabela para o atributo <code>tagId</code> da classe modelo
      usado pela biblioteca <u>sql2o</u></p>

    {% include gist.html id=gistAnswer3 lines="3,9,17,18,22,26,40,45,50"
            filename="PostDao-modificado-r213.java"
            title="<kbd><b>PostDao.java</b></kbd> (apenas os m√©todos alterados)" %}
  </li>
</ol>
